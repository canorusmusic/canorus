# Makefile for Canorus OS X package
#
# NOTE: Before running this file, do "make install" from the main source directory

# The name of the disk image file
DMG_FILE = Canorus.dmg

# The directory that servers as the root of the disk image
DMG_DIR = Canorus

# The directory that serves at the root of the package installation tree
PACKAGE_ROOT = package-contents

# Directory that contains the .app
APP_DIR = $(PACKAGE_ROOT)/Applications

# Directory containing misc. resources
RESOURCES_DIR = files

# Path to the PackageMaker executable
PACKAGEMAKER = /Developer/Applications/Utilities/PackageMaker.app/Contents/MacOS/PackageMaker

# This file lists the libraries that the canorus executable links to;
# we need to look for these names in the executable and change them
# to point to the the .app's private copies.
INSTALLED_LIBS_FILE = OSX_installed_libs.txt



all: test links files permissions pkg dmg

# Test for prerequisites
test:
	test -f $(INSTALLED_LIBS_FILE)


# Change the link info for the libraries installed inside the .app
links:
	./change-libraries.sh $(APP_DIR)/Canorus.app/Contents `cat $(INSTALLED_LIBS_FILE)`


# Copy files from the resources dir to the right place
files:
	cp $(RESOURCES_DIR)/README-OSX.txt      $(DMG_DIR)
	cp $(RESOURCES_DIR)/canorus-example.xml $(DMG_DIR)
	cp $(RESOURCES_DIR)/Emmentaler-Mac.ttf $(PACKAGE_ROOT)/Library/Fonts/


# Change permissions on the .app
permissions:
	chmod -R 0664 $(RESOURCES_DIR)/*  
	chgrp -R admin $(PACKAGE_ROOT) $(RESOURCES_DIR)/* 
	sudo chown -R root $(PACKAGE_ROOT) files 


# Create the .pkg file
pkg:
	$(PACKAGEMAKER) -build -v -ds \
	        -p "$(DMG_DIR)/Canorus.pkg" \
	        -f "$(PACKAGE_ROOT)" \
	        -r "$(RESOURCES_DIR)" \
	        -i "$(RESOURCES_DIR)/Info.plist" \
	        -d "$(RESOURCES_DIR)/Description.plist"


# Create the .dmg file
dmg:
	hdiutil create -srcfolder $(DMG_DIR) Canorus.dmg 


# Remove all $(RESOURCES_DIR) generated by the packaging process
pkgclean:
	rm $(DMG_FILE)
	sudo rm -rf $(DMG_DIR)/*


# remove all files generated by "make install" from cmake;
# see also "make uninstall" by cmake
instclean:
	sudo rm -rf $(PACKAGE_ROOT)/*
	rm -f $(INSTALLED_LIBS_FILE)


allclean: instclean pkgclean
