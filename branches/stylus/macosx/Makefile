# Makefile for Canorus OS X package
#
# NOTE: Before running this file, do "make install" from the main source directory

# The name of the disk image file
DMG_FILE = Canorus.dmg

# The directory that servers as the root of the disk image
DMG_DIR = Canorus

# The directory that serves at the root of the package installation tree
PACKAGE_ROOT = package-contents

# Directory that contains the .app
APP_DIR = $(PACKAGE_ROOT)/Applications

FRAMEWORKS_DIR = $(APP_DIR)/Canorus.app/Contents/Frameworks

# Directory containing misc. resources
RESOURCES_DIR = files

# File with platform-specific instructions
README_FILE = README-OSX.txt

# Path to the PackageMaker executable
PACKAGEMAKER = /Developer/Applications/Utilities/PackageMaker.app/Contents/MacOS/PackageMaker

# This file lists the libraries that the canorus executable links to;
# we need to look for these names in the executable and change them
# to point to the the .app's private copies.
INSTALLED_LIBS_FILE = OSX_installed_libs.txt



all: files permissions pkg dmg

# append Canorus version with SVN revision to README-OSX, e.g. "Version 0.3svn R509" 
readme:
	perl -e '$$line = <STDIN>;	\
		if ($$line =~ /svn/) {	\
			chomp $$line;	\
			$$rev = `svn info | sed -n "/Revision/ p"`;	\
			$$rev =~ s/Revision: /R/;	\
		}	\
		print "Canorus\nVersion $$line $$rev\n";' < ../VERSION >$(DMG_DIR)/$(README_FILE)
		cat $(RESOURCES_DIR)/$(README_FILE) >> $(DMG_DIR)/$(README_FILE)


# Test for prerequisites:
# change-libraries.sh uses the INSTALLED_LIBS_FILE to determine the libraries to change
test:
	test -f $(INSTALLED_LIBS_FILE)


# Change the link info for the libraries installed inside the .app
# not working presently 2007-06-09
links:
	./change-libraries.sh $(APP_DIR)/Canorus.app/Contents `cat $(INSTALLED_LIBS_FILE)`


# Copy files from the resources dir to the right place
files: readme
	cp $(RESOURCES_DIR)/canorus-example.xml $(DMG_DIR)
	cp $(RESOURCES_DIR)/Emmentaler-14.ttf $(PACKAGE_ROOT)/Library/Fonts/


# Change permissions on the .app
permissions:
	chmod -R 0775 $(PACKAGE_ROOT)
	chgrp -R admin $(PACKAGE_ROOT) 
	sudo chown -R root $(PACKAGE_ROOT) 


# Create the installer .pkg file
pkg:
	$(PACKAGEMAKER) -build -v -ds \
	        -p "$(DMG_DIR)/Canorus.pkg" \
	        -f "$(PACKAGE_ROOT)" \
	        -r "$(RESOURCES_DIR)" \
	        -i "$(RESOURCES_DIR)/Info.plist" \
	        -d "$(RESOURCES_DIR)/Description.plist"


# Create the .dmg (disk image) file
dmg:
	hdiutil create -srcfolder $(DMG_DIR) Canorus.dmg 


# Remove all files generated by the packaging process
pkgclean:
	rm -f $(DMG_FILE)
	sudo rm -rf $(DMG_DIR)/*


# remove all files generated by "make install" from cmake;
# see also "make uninstall" by cmake
instclean:
	sudo rm -rf $(PACKAGE_ROOT)/*
	rm -f $(INSTALLED_LIBS_FILE)


allclean: instclean pkgclean
